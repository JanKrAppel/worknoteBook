#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Created on Thu Aug 27 20:41:07 2015

@author: appel
"""

if __name__ == '__main__':
    from argparse import ArgumentParser
    from os.path import exists, expanduser
    from os import makedirs
    parser = ArgumentParser()
    parser.add_argument('command', help='Command to execute', choices=['server',
                                                                       'list',
                                                                       'download',
                                                                       'upload',
                                                                       'add_server',
                                                                       'set_default_server',
                                                                       'search',
                                                                       'delete'])
    parser.add_argument('--index', '-i', type=str, default='1', help='Select the index')
    parser.add_argument('--workdir', '-w', type=str, default=None, help='Select the working directory')
    parser.add_argument('--overwrite', '-o', action='store_true', help='Overwrite worknote, if present')
    parser.add_argument('--server', '-s', type=str, default='', help='Set the server name')
    parser.add_argument('--url', type=str, default='', help='Set the server URL')
    parser.add_argument('--port', type=int, default=0, help='Set the server port')
    parser.add_argument('--chapter', '-c', type=str, default='', help='Chapter to upload worknote to')
    parser.add_argument('--query', '-q', type=str, default='', help='String to search for')
    args = parser.parse_args()
    
    if not exists(expanduser('~/.worknoteBook/storage')):
        makedirs(expanduser('~/.worknoteBook/storage'))
    if args.command == 'server':
        import cherrypy
        from worknoteBookServer import worknoteBookServer
        from worknoteBookHelpers import Configuration
        default_cfg = {'server': {'storagedir': '~/.worknoteBook/storage',
                                  'url': '0.0.0.0',
                                  'port': 8080}}
        server_cfg = Configuration(expanduser('~/.worknoteBook/server.cfg'), default_cfg)
        if not exists(expanduser('~/.worknoteBook/server.cfg')):
            server_cfg.update_cfg_file()
        cherrypy.quickstart(worknoteBookServer(server_cfg))
    else:
        from worknoteBookClient import worknoteBookClient
        from worknoteBookHelpers import Configuration
        default_cfg = {'client_defaults': {'server': 'localhost'},
                       'localhost': {'url': '127.0.0.1',
                                     'port': 8080}}
        client_cfg = Configuration(expanduser('~/.worknoteBook/client.cfg'), default_cfg)
        if not exists(expanduser('~/.worknoteBook/client.cfg')):
            client_cfg.update_cfg_file()
        client = worknoteBookClient(client_cfg)
        server_name = args.server
        if server_name == '':
            server_name = None
        if args.command == 'list':
            client.list()
        elif args.command == 'download':
            client.download(args.index, args.workdir, server_name)
        elif args.command == 'upload':
            client.upload(args.workdir, args.overwrite, server_name, args.chapter)
        elif args.command == 'add_server':
            client.add_server(server_name, args.url, args.port)
        elif args.command == 'set_default_server':
            client.set_default_server(server_name)
        elif args.command == 'search':
            client.search(args.query, server_name)
        elif args.command == 'delete':
            client.delete(args.index, server_name)

